# 一、问题 2 的目标（数学表述）

设孕妇 BMI 为 $b$、孕周为 $t$。在第一问的 GAMM 模型中，可得到在 $(t,b)$ 的 **logit 预测均值** $\eta(t,b)$ 与其 **标准误** $\mathrm{SE}(t,b)$。在给定置信水平（例如 $95\%$）下的 **比例下置信限** 定义为
\[
\mathrm{LCL}(t,b)
= \operatorname{logit}^{-1}\!\big(\,\eta(t,b)\;-\;z\,\mathrm{SE}(t,b)\,\big),
\]
其中 $z$ 为相应正态分位数，$\operatorname{logit}^{-1}(x)=1/(1+e^{-x})$。

- **达标周（最早达标时间）**：给定 $b$，定义
\[
t^\star(b)\;=\;\min\Big\{\,t:\ \Pr\big(Y(t,b)\ge 0.04\big)\ \ge\ \pi\,\Big\}
\ \approx\
\min\Big\{\,t:\ \mathrm{LCL}(t,b)\ \ge\ 0.04\,\Big\},
\]
其中 $\pi$ 为服务/置信水平（常取 $0.90$ 或 $0.95$）。

- **问题 2 的任务**：把 BMI 轴分成若干段 $[a_g,a_{g+1})$（即**合理分组**），并为每一组选择一个**统一检测周** $T_g$，使总体**潜在风险**最小。

- **风险函数（按题意早/中/晚）**：
\[
\mathrm{Risk}(t)=
\begin{cases}
r_{\text{early}}, & t\le 12,\\
r_{\text{mid}},   & 13\le t\le 27,\\
r_{\text{late}},  & t\ge 28,
\end{cases}
\qquad
\text{且 } r_{\text{early}}<r_{\text{mid}}<r_{\text{late}}.
\]
若在组时点 $T_g$ 采血仍未达标（$\Pr(Y\ge 0.04)<\pi$，保守近似为 $\mathrm{LCL}(T_g,b)<0.04$），则需要复检并产生滞后时间与成本。

---

# 二、用现有模型得到“达标周曲线” $t^\star(b)$

**步骤：**
1. 固定某个 $b$，在孕周网格（如 $8\!\sim\!30$ 周）上，利用第一问模型计算 $\eta(t,b)$ 与 $\mathrm{SE}(t,b)$，进而得 $\mathrm{LCL}(t,b)$。
2. 选服务水平 $\pi$，用 “$\Pr(Y\ge 0.04)\ge\pi$ 由 $\mathrm{LCL}(t,b)\ge 0.04$ 近似”。
3. 在网格上寻找首次满足 $\mathrm{LCL}(t,b)\ge 0.04$ 的 $t$，必要时做**线性插值**得到更精细的 $t^\star(b)$。
4. 对 $b\in[b_{\min},b_{\max}]$ 的细网格重复 1–3，得到 **达标周曲线** $t^\star(b)$（可再做**单调回归/低自由度样条**以去噪和平滑）。

> 以上直接复用第一问脚本中“固定效应预测 + 协方差求置信带”的代码框架，仅新增“阈值首次穿越”的计算。

---

# 三、把 $t^\star(b)$ 离散化为“BMI 分组 + 组内统一时点”

## 方案 A（简单稳妥，便于阐述）
- 先对 $t^\star(b)$ 做 **单调回归**（Isotonic）或低自由度样条，使其随 BMI **单调、平滑**。
- 取组数 $G$（如 $4\!\sim\!6$），按 BMI 的**分位数**将样本切为 $G$ 段。
- 组内统一时点 $T_g$ 取该段 $t^\star(b)$ 的**高分位**（如 $0.8$ 或 $0.9$ 分位），以保证大多数人在 $T_g$ 已达 $\mathrm{LCL}\ge 0.04$。

## 方案 B（数据驱动最优分段，**推荐**）

把“组内统一时点导致的**过早/过晚**”写成**可加损失**，对 BMI 升序的一维序列做**动态规划**分段，并在每段内选最优 $T_g$。

- **个体损失**（$b$ 属于第 $g$ 段、组时点为 $T_g$）：
\[
\ell(b,T_g)
=\underbrace{\mathbf{1}\{\mathrm{LCL}(T_g,b)<0.04\}\,c_{\text{retest}}}_{\text{复检成本}}
\;+\;
\underbrace{\mathrm{Risk}\!\big(T_g+\Delta(b,T_g)\big)}_{\text{滞后带来的风险}},
\]
其中
\[
\Delta(b,T_g)=\min\{t\ge T_g:\ \mathrm{LCL}(t,b)\ge 0.04\}\;-\;T_g
\]
为“若 $T_g$ 未达标到下一次达标的**等待时间**”，$c_{\text{retest}}$ 为复检单位成本。

- **段内最优时点**：对候选段 $(i,j]$（即第 $i\!+\!1\sim j$ 个样本）在候选集合 $\mathcal{T}\subset[8,30]$ 上试遍 $T$，最小化
\[
C\big((i,j]\big)\;=\;\min_{T\in\mathcal{T}} \ \sum_{b\in(i,j]} \ell(b,T),
\]
得到该段最优 $T^\star$ 与段成本 $C$。

- **全局最优分段（DP）**：设 $DP[j,k]$ 为“前 $j$ 个样本切成 $k$ 段”的最小损失，转移
\[
DP[j,k]\;=\;\min_{i<j}\Big\{\,DP[i,k-1]\;+\;C\big((i,j]\big)\,\Big\}.
\]
回溯得到 $G$ 段边界与各段 $T_g^\star$。这在定义的损失下是**全局最优**的“BMI 分组 + 统一时点”。

## 方案 C（聚类近似）
- 先算每个样本的 $t^\star(b_i)$，对 $\{t^\star(b_i)\}$ 做 1D $k$-means/Jenks，自然断点得到分组；每组 $T_g$ 取组内 $t^\star$ 的高分位。实现快，但不如方案 B 严格刻画“复检与滞后”的代价。

---

# 四、把“检测误差”纳入并做敏感性分析

1. **测量误差建模（logit 空间）**  
设固定效应标准误为 $s_{\text{fe}}(t,b)$，附加测量误差 $\varepsilon\sim\mathcal{N}(0,\sigma_m^2)$，则有效不确定度
\[
s^2(t,b)\;=\;s_{\text{fe}}^2(t,b)\;+\;\sigma_m^2.
\]
实现上等价于在生成 $\mathrm{LCL}$ 时把标准误放大为 $s(t,b)$，从而 $t^\star(b)$ **整体右移**。

2. **灵敏度分析**  
取若干 $\sigma_m$ 水平（如 $0,\,0.1,\,0.2$），重复“$t^\star(b)$→分段优化”，比较各组 $T_g$ 的变化。一个量纲正确的近似是
\[
\Delta t\ \approx\ \frac{z\,\sigma_m}{\partial \eta/\partial t}\,,
\]
即阈值附近 $\eta$ 对 $t$ 的斜率越大，误差引起的时间推迟越小。

3. **Bootstrap（可选）**  
对原数据行级重采样、重拟合 MixedLM，重复流程，给出分组边界与 $T_g$ 的置信区间。

---

# 五、实现清单（与现有脚本最少改动）

1. 复用第一问脚本计算 $\eta(t,b)$ 与 $\mathrm{SE}(t,b)$（你已有“置信带”计算）。  
2. 新增函数 `first_hit_time(b, pi=0.95, sigma_m=0)`：在孕周网格上计算 $\mathrm{LCL}(t,b)$ 并返回首次 $t$ 使 $\mathrm{LCL}\ge 0.04$（可插值）。  
3. 生成三类图：  
   - $t^\star(b)$ 曲线（不同 $\sigma_m$ 三条）；  
   - “BMI 分组 + 组内 $T_g$”叠加在 $t^\star(b)$ 上；  
   - 灵敏度：$T_g$ 随 $\sigma_m$ 的折线。  
4. 输出核心表：组号、BMI 区间、$T_g$、覆盖率 $\Pr\{\mathrm{LCL}(T_g,b)\ge 0.04\}$、复检率、平均发现周（含等待）、相对风险指数。  
5. （可选）与临床经验分组对比同表指标，展示改进幅度。

---

# 六、目标函数与论文表述模板

**（方案 B）总体目标函数：**
\[
\min_{\{[a_g,a_{g+1}),\,T_g\}_{g=1}^G}
\ \sum_{g=1}^{G}\ \sum_{b_i\in[a_g,a_{g+1})}
\Big[
\mathbf{1}\{\mathrm{LCL}(T_g,b_i)<0.04\}\,c_{\text{retest}}
\;+\;
\mathrm{Risk}\!\big(T_g+\Delta(b_i,T_g)\big)
\Big].
\]

**文字表述示例：**  
“我们在 MixedLM 的固定效应预测基础上，以**阈值首次穿越**定义个体‘最早达标周’ $t^\star(b)$，并构造包含‘复检成本 + 晚发现风险’的段内可加损失，采用**动态规划最优分段**得到 $G$ 个 BMI 区间及其统一采血时点 $T_g$。与经验分组相比，本方案在**晚期发现（$\ge 28$ 周）**风险指标上降低 $X\%$、复检率降低 $Y\%$；在 $\sigma_m\in[0,0.2]$ 的测量误差下，各组 $T_g$ 的变化 $\le Z$ 周，结果稳健。”

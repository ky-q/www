# 第三问总体思路（一句话版）

在**男胎**数据上，用一问的连续模型（Y 浓度 ~ 孕周样条 + 协变量，含随机截距）拓展加入“身高、体重、年龄”等影响因子，**从连续预测推导“达标概率”**（≥4%），在二问的**分段 + 统一时点 DP**框架里，把目标从“期望成本最小”升级为“**在满足/惩罚达标比例目标**的条件下使潜在风险最小”，并做误差灵敏度与稳健性分析。题面要求“达标比例（浓度≥4%的比例）”明确出现，阈值请用 **0.04**。

---

## 步骤 0｜统一题面口径

- **达标阈值**从 0.05 调整为 **0.04**（题面写“达到或超过 4%”）。你现在的二问程序里 `CFG.THRESHOLD = 0.05`，需要改成 `0.04`。  
- 仍只对**男胎**样本建模与分组（Y 列有值的一部分）。

---

## 步骤 1｜数据准备（男胎）

1. 读取“男胎检测数据”工作表；清洗并标准化以下字段：孕周（转数值周）、BMI、年龄、身高、体重、（可选）读段相关质量指标（如总读段数、唯一比对读段数、GC、比对比例等）。  
2. 注意**多次检测的同一孕妇**需要保留（随机截距会处理相关性），但在做“BMI 的经验分布权重”时建议按孕妇去重（取该孕妇 BMI 的**中位数**）以避免重复计权——这与你二问写法一致，可复用。

---

## 步骤 2｜扩展一问的连续模型（核心预测器）

在你一问的 `gamm_mixedlm_B.py` 基础上扩展固定效应：

- **被解释变量**：`logit(Y浓度)`（你的实现已经这样做了）。  
- **固定效应**：
  - `s(孕周)` 的 B 样条（已实现）；  
  - `BMI`（已实现）；  
  - **新增**：年龄（可线性或分段样条）、体重残差（对 BMI 做去相关后可留一个“超重度”残差）、身高（若与 BMI/体重强共线，则只保留二者之一或使用正交化/残差化）；  
  - （可选）测序质量指标（如读段数、比对比例、GC）作为控制变量，减少方差和偏差。  
- **随机效应**：孕妇代码随机截距（已实现）。  
- **输出**：与现在一致，保留固定效应协方差，用于后续把“点预测”转成“**下置信界**→ 达标概率”。

> 小提示：不要与 BMI 强共线。可以先做一次 VIF/相关性检查，或把“体重”替换为“体重相对 BMI 的残差”。

---

## 步骤 3｜从连续模型得到“达标概率”

延用二问里的思路：在 **logit 空间**上把固定效应预测值 `η(t; x)` 与其标准误 `se(t; x)` 合成**下置信界** `η_LCL = η - z*SE_eff`，再反 logit 得到概率 `p_LCL(t; x)`。其中 `SE_eff^2 = se^2 + σ_m^2 (+ 软下限外推项)`，`σ_m` 表示测量/模型不确定度（延续你在二问里的 `SIGMA_M` 设定），软/硬下限策略也可沿用。

- **达标概率**：`P_reach(t | x) = Pr(Y≥0.04)` 用 `p_LCL(t; x)` 近似（保守侧）。  
- **最早达标时刻**：  
  \[
  t^*(x) = \min\{t : p_{LCL}(t;x) \ge p_0\}
  \]  
  这里的 `p0` 是你对“达标概率”的置信目标（如 0.9 或 0.95），与二问里的 `CONF_LEVEL` 角色不同，别混淆：  
  - `CONF_LEVEL` 决定 z 分位；  
  - `p0` 是“达标比例目标”，第三问提到“达标比例”就应该体现在目标/约束里。

---

## 步骤 4｜只按 BMI 分组，但“综合考虑其他因子”

题面要求“**根据 BMI 给出合理分组**”，同时“综合考虑身高、体重、年龄等因素”。做法是：

- **分组维度**仍是 BMI；  
- 在计算**段成本/覆盖率**时，对每个 BMI 代表点 **整合（边缘化）该 BMI 邻域内的其他协变量分布**。  
  - **经验核加权**：对与该 BMI 接近的样本（如 ±0.5 或按 KNN）收集其 (年龄、身高、体重、质量指标等) 作为 `x` 的经验分布；  
  - **分箱-重采样**：把数据分成细 BMI bins，在每个 bin 里对 `x` 做有放回抽样（或直接用该 bin 的观测集合）来近似条件分布。  

这样就“综合考虑”了其他因子，但**分组边界只在 BMI 轴上**，符合题意。

---

## 步骤 5｜目标函数与约束（第三问关键差异）

在二问的成本框架上（风险 + 复检成本 + 等待惩罚），加入**达标比例约束/惩罚**：

- 对某组给定统一时点 `T_g`，计算该组**首检达标比例**  
  \[
  \text{coverage}(T_g) = \mathbb{E}_{x|BMI\in组}\big[ \mathbf{1}\{p_{LCL}(T_g;x)\ge 0.5\}\big]
  \]  
  或直接用 `p_LCL(T_g; x)` 的组平均作为保守覆盖率近似。  
- **两种处理方式**：  
  1. **硬约束**：要求 \(\text{coverage}(T_g)\ge \tau\)（如 90% 或 95%），否则该 `T_g` 不可行；  
  2. **软惩罚**：把 \(\max(0,\tau-\text{coverage})\) 乘以一个大系数加进段成本（推荐，便于搜索）。  

> 其余成本项可沿用你二问：复检次数 × 复检成本 + 分段风险（早/中/晚 piecewise），另可保留“等待惩罚”（`T_g` 跨过 `t*(x)`的滞后罚）。

---

## 步骤 6｜为每个 BMI 代表点与候选时点生成**期望成本**

对每个 BMI 代表点 \(b_i\) 与候选时点 \(T_j\)：

1. 依据步骤 4 的条件样本 \(\{x_{i,r}\}_{r=1}^R\)（固定 BMI 邻域的其他因子抽样/收集），计算：  
   - 个人的最早达标 \(t^*(x_{i,r})\)；  
   - 在时点 \(T_j\) 下是否首检达标、需要复检的次数与真实检出时刻；  
   - piecewise 风险（早/中/晚）与等待惩罚；  
2. 对 \(r\) 求**加权平均**（权重来自该 BMI 代表点的经验权重 × 条件样本频数）得到 `L[i, j]`。  
3. **同时**计算该 \(T_j\) 下的组覆盖率估计，用于硬约束筛除或软惩罚。  

---

## 步骤 7｜固定段数 DP 求最优分组与统一时点

- 复用你二问的 `build_segment_costs(...)` + `dp_optimal_partition(...)`，只需将“段成本”定义替换为**含达标比例约束/惩罚**的新 `L`。  
- 仍支持最小段长、K 段固定数的全局最优。

---

## 步骤 8｜灵敏度与稳健性分析（第三问要点）

1. **测量/模型误差**：扫描 `σ_m`（如 0、0.1、0.2）并重做 DP，观察每组 \(T_g\) 的变化（你二问已有对应图 3，直接复用扩展）。  
2. **达标比例门槛 \(\tau\)**：扫描 0.85/0.90/0.95，比较整体风险、复检率、晚期占比。  
3. **组数 K**：比较 K=3/4/5 的 Pareto 曲线（总成本 vs 晚期占比/复检率）。  
4. **外推下限策略**（软/硬）与外推惩罚参数。  
5. **协变量集**：加入/移除质量指标或只保留“年龄+体重残差”，观察稳健性。

---

## 步骤 9｜可交付物（建议论文与附图）

- 表：每组 BMI 区间、统一时点 \(T_g\)、首检覆盖率、复检率、人均复检次数、平均检出周、晚期占比、期望风险/总成本、样本权重。  
- 图 1：\(t^*(\text{BMI})\) 曲线（若包含误差带/σ_m 对比更好）。  
- 图 2：**最优 BMI 分组 + 每组水平线 \(T_g\)**（叠加 \(t^*(b)\)）。  
- 图 3：**\(T_g\) 对 σ_m 的敏感性**（各组随 σ_m 变化曲线）。  
- 图 4：**覆盖率—总成本**的权衡曲线（扫描 \(\tau\)）。  
- 附：模型摘要、变量显著性、拟合诊断、共线性与残差检查。

---

## 需要改动的代码位置（逐条列给你）

### 在 `gamm_mixedlm_B.py`（第一问模型）里：

1. **设计矩阵**：在你现在的  
   > “孕周的 B 样条 + BMI（可选交互）”  
   基础上，新增 `Age`、`Height`、`Weight_resid`（体重去除 BMI 线性影响后的残差）等列。保持 `drop_near_constant_and_collinear` 的秩处理逻辑。  
2. **导出参数**：`global_model` 里增加 `used_covariates`（列名清单）与这些新列在 `predict_logit_and_se` 中的处理规则（常数、直接抄列，或样条）。  
3. **门槛**：无需在一问处改阈值，但建议把 `thr=0.04` 写进注释，提醒与三问对齐。

### 在 `planB_constrained.py`（二问分段框架）里：

1. **阈值**：`CFG.THRESHOLD = 0.04`。  
2. **覆盖率门槛**：新增 `CFG.COVERAGE_TARGET = 0.90`（或论文再给三档对比）。  
3. **条件整合**：  
   - 新增一个 `sample_conditionals(bmi_i)` 函数：返回该 BMI 邻域的 \(\{x_{i,r}, w_{i,r}\}\)。  
   - 在 `precompute_loss_matrix(...)` 内部，把“单一 b、单一 x”的计算改为“对 \(r\) 做权重平均”（或把这层期望吸收到 `individual_loss` 的外层）。  
4. **覆盖率约束/惩罚**：  
   - 计算 `coverage[i, j]`；  
   - 若“硬约束”，对不达 \(\tau\) 的 `T_j` 令 `L[i, j] = +∞`；  
   - 若“软惩罚”，加项 `lambda_cov * max(0, τ - coverage)`（新增 `CFG.LAMBDA_COV`）。  
5. **输出**：在 `group_eval` 里增加 `coverage` 字段（你已有），明确其与 `τ` 的关系，并在图 2 的标注里加“coverage=xx%”。

---

## 评估与写作要点

- **为什么要“概率约束/惩罚”**：题面第三问明确“达标比例”，必须在目标设计里出现（不是只看均值或单个 t*）。  
- **为什么仍按 BMI 分组**：题面要求“根据 BMI 给出分组”，其他因子只作为建模与成本期望的**条件分布**进入，不改变分组维度。  
- **为什么保留 MixedLM**：可处理同一孕妇多次检测的相关性，且你的一问实现已稳定可复用。  
- **为什么沿用 DP**：你的二问框架已实现“固定段数、全局最优”的分段搜索，第三问只需换“段成本”的定义。

---

## 常见坑

- **BMI 与体重/身高强共线**：请做变量正交化或只留 BMI + Age；不要把“身高、体重、BMI”原样全进模型。  
- **过度外推**：软/硬下限要与训练支撑区间对齐；外推惩罚（soft floor）保留。  
- **把 置信水平 与 达标比例 混为一谈**：前者进的是 z 值，后者是覆盖率门槛/惩罚项——二者作用位置不同。  
- **代表点过少**：等频压缩后要保证 `MIN_SEG_SIZE` 合理（你二问已有这个保护），否则 DP 不可行。
